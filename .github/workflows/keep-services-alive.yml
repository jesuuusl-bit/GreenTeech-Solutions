name: Keep Render Services Alive

on:
  schedule:
    # Ejecutar cada 10 minutos para mantener servicios activos
    - cron: '*/10 * * * *'
  workflow_dispatch: # Permitir ejecuci√≥n manual

jobs:
  ping-services:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service:
          - name: "API Gateway"
            url: "${{ secrets.RENDER_API_GATEWAY_URL || 'https://your-api-gateway.onrender.com' }}"
          - name: "Users Service" 
            url: "${{ secrets.RENDER_USERS_SERVICE_URL || 'https://your-users-service.onrender.com' }}"
          - name: "Projects Service"
            url: "${{ secrets.RENDER_PROJECTS_SERVICE_URL || 'https://your-projects-service.onrender.com' }}"
          - name: "Monitoring Service"
            url: "${{ secrets.RENDER_MONITORING_SERVICE_URL || 'https://your-monitoring-service.onrender.com' }}"
          - name: "Predictive Service"
            url: "${{ secrets.RENDER_PREDICTIVE_SERVICE_URL || 'https://your-predictive-service.onrender.com' }}"
          - name: "Documents Service"
            url: "${{ secrets.RENDER_DOCUMENTS_SERVICE_URL || 'https://your-documents-service.onrender.com' }}"

    steps:
      - name: Ping ${{ matrix.service.name }}
        run: |
          echo "üîÑ Pinging ${{ matrix.service.name }} at ${{ matrix.service.url }}"
          
          # Intentar hacer ping al servicio
          response=$(curl -s -w "%{http_code}" -o /dev/null --max-time 30 "${{ matrix.service.url }}/health" || echo "000")
          
          if [ "$response" = "200" ] || [ "$response" = "404" ]; then
            echo "‚úÖ ${{ matrix.service.name }} is alive (HTTP $response)"
          else
            echo "‚ö†Ô∏è ${{ matrix.service.name }} might be sleeping (HTTP $response)"
            
            # Intentar despertar el servicio haciendo una segunda llamada
            echo "üîÑ Attempting to wake up ${{ matrix.service.name }}..."
            sleep 5
            curl -s --max-time 30 "${{ matrix.service.url }}" > /dev/null || echo "Wake-up call sent"
          fi
        continue-on-error: true

  trigger-deployments:
    runs-on: ubuntu-latest
    needs: ping-services
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Trigger all service deployments
        run: |
          echo "üöÄ Triggering all service deployments to ensure they're up to date..."
          
          # Solo ejecutar si se configuraron los secrets
          services=(
            "RENDER_DEPLOY_HOOK_API_GATEWAY"
            "RENDER_DEPLOY_HOOK_USERS_SERVICE"
            "RENDER_DEPLOY_HOOK_PROJECTS_SERVICE"
            "RENDER_DEPLOY_HOOK_MONITORING_SERVICE"
            "RENDER_DEPLOY_HOOK_PREDICTIVE_SERVICE"
            "RENDER_DEPLOY_HOOK_DOCUMENTS_SERVICE"
          )
          
          for service in "${services[@]}"; do
            if [ ! -z "${{ secrets[service] }}" ]; then
              echo "Triggering deployment for $service"
              curl -X POST "${{ secrets[service] }}" || echo "Failed to trigger $service"
              sleep 2
            else
              echo "‚ö†Ô∏è $service not configured"
            fi
          done

  summary:
    runs-on: ubuntu-latest
    needs: [ping-services]
    if: always()
    steps:
      - name: Service Status Summary
        run: |
          echo "üìä Keep-alive job completed"
          echo "This workflow helps prevent Render services from going to sleep"
          echo "Configure the service URLs in GitHub secrets for better monitoring"