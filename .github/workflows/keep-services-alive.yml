name: Keep Render Services Alive

on:
  schedule:
    # Ejecutar cada 10 minutos para mantener servicios activos
    - cron: '*/10 * * * *'
  workflow_dispatch: # Permitir ejecuci√≥n manual

jobs:
  ping-services:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service:
          - name: "API Gateway"
            secret_name: "RENDER_API_GATEWAY_URL"
            default_url: "https://your-api-gateway.onrender.com"
          - name: "Users Service" 
            secret_name: "RENDER_USERS_SERVICE_URL"
            default_url: "https://your-users-service.onrender.com"
          - name: "Projects Service"
            secret_name: "RENDER_PROJECTS_SERVICE_URL"
            default_url: "https://your-projects-service.onrender.com"
          - name: "Monitoring Service"
            secret_name: "RENDER_MONITORING_SERVICE_URL"
            default_url: "https://your-monitoring-service.onrender.com"
          - name: "Predictive Service"
            secret_name: "RENDER_PREDICTIVE_SERVICE_URL"
            default_url: "https://your-predictive-service.onrender.com"
          - name: "Documents Service"
            secret_name: "RENDER_DOCUMENTS_SERVICE_URL"
            default_url: "https://your-documents-service.onrender.com"

    steps:
      - name: Ping ${{ matrix.service.name }}
        env:
          SERVICE_URL: ${{ secrets[matrix.service.secret_name] || matrix.service.default_url }}
        run: |
          echo "üîÑ Pinging ${{ matrix.service.name }} at $SERVICE_URL"
          
          # Intentar hacer ping al servicio
          response=$(curl -s -w "%{http_code}" -o /dev/null --max-time 30 "$SERVICE_URL/health" || echo "000")
          
          if [ "$response" = "200" ] || [ "$response" = "404" ]; then
            echo "‚úÖ ${{ matrix.service.name }} is alive (HTTP $response)"
          else
            echo "‚ö†Ô∏è ${{ matrix.service.name }} might be sleeping (HTTP $response)"
            
            # Intentar despertar el servicio haciendo una segunda llamada
            echo "üîÑ Attempting to wake up ${{ matrix.service.name }}..."
            sleep 5
            curl -s --max-time 30 "$SERVICE_URL" > /dev/null || echo "Wake-up call sent"
          fi
        continue-on-error: true

  trigger-deployments:
    runs-on: ubuntu-latest
    needs: ping-services
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Trigger all service deployments
        env:
          HOOK_API_GATEWAY: ${{ secrets.RENDER_DEPLOY_HOOK_API_GATEWAY }}
          HOOK_USERS_SERVICE: ${{ secrets.RENDER_DEPLOY_HOOK_USERS_SERVICE }}
          HOOK_PROJECTS_SERVICE: ${{ secrets.RENDER_DEPLOY_HOOK_PROJECTS_SERVICE }}
          HOOK_MONITORING_SERVICE: ${{ secrets.RENDER_DEPLOY_HOOK_MONITORING_SERVICE }}
          HOOK_PREDICTIVE_SERVICE: ${{ secrets.RENDER_DEPLOY_HOOK_PREDICTIVE_SERVICE }}
          HOOK_DOCUMENTS_SERVICE: ${{ secrets.RENDER_DEPLOY_HOOK_DOCUMENTS_SERVICE }}
        run: |
          echo "üöÄ Triggering all service deployments to ensure they're up to date..."
          
          # API Gateway
          if [ ! -z "$HOOK_API_GATEWAY" ]; then
            echo "Triggering API Gateway deployment..."
            curl -X POST "$HOOK_API_GATEWAY" || echo "Failed to trigger API Gateway"
            sleep 2
          else
            echo "‚ö†Ô∏è RENDER_DEPLOY_HOOK_API_GATEWAY not configured"
          fi
          
          # Users Service
          if [ ! -z "$HOOK_USERS_SERVICE" ]; then
            echo "Triggering Users Service deployment..."
            curl -X POST "$HOOK_USERS_SERVICE" || echo "Failed to trigger Users Service"
            sleep 2
          else
            echo "‚ö†Ô∏è RENDER_DEPLOY_HOOK_USERS_SERVICE not configured"
          fi
          
          # Projects Service
          if [ ! -z "$HOOK_PROJECTS_SERVICE" ]; then
            echo "Triggering Projects Service deployment..."
            curl -X POST "$HOOK_PROJECTS_SERVICE" || echo "Failed to trigger Projects Service"
            sleep 2
          else
            echo "‚ö†Ô∏è RENDER_DEPLOY_HOOK_PROJECTS_SERVICE not configured"
          fi
          
          # Monitoring Service
          if [ ! -z "$HOOK_MONITORING_SERVICE" ]; then
            echo "Triggering Monitoring Service deployment..."
            curl -X POST "$HOOK_MONITORING_SERVICE" || echo "Failed to trigger Monitoring Service"
            sleep 2
          else
            echo "‚ö†Ô∏è RENDER_DEPLOY_HOOK_MONITORING_SERVICE not configured"
          fi
          
          # Predictive Service
          if [ ! -z "$HOOK_PREDICTIVE_SERVICE" ]; then
            echo "Triggering Predictive Service deployment..."
            curl -X POST "$HOOK_PREDICTIVE_SERVICE" || echo "Failed to trigger Predictive Service"
            sleep 2
          else
            echo "‚ö†Ô∏è RENDER_DEPLOY_HOOK_PREDICTIVE_SERVICE not configured"
          fi
          
          # Documents Service
          if [ ! -z "$HOOK_DOCUMENTS_SERVICE" ]; then
            echo "Triggering Documents Service deployment..."
            curl -X POST "$HOOK_DOCUMENTS_SERVICE" || echo "Failed to trigger Documents Service"
            sleep 2
          else
            echo "‚ö†Ô∏è RENDER_DEPLOY_HOOK_DOCUMENTS_SERVICE not configured"
          fi

  summary:
    runs-on: ubuntu-latest
    needs: [ping-services]
    if: always()
    steps:
      - name: Service Status Summary
        run: |
          echo "üìä Keep-alive job completed"
          echo "This workflow helps prevent Render services from going to sleep"
          echo "Configure the service URLs in GitHub secrets for better monitoring"